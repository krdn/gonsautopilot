# 에스컬레이션 정책

파이프라인 실패가 반복될 때의 단계별 대응 정책입니다.

## 에스컬레이션 단계

| 실패 횟수 | 대응 | 설명 |
|-----------|------|------|
| **1회** | 자동 롤백 + 로그 저장 | 일시적 문제일 수 있으므로 조용히 처리 |
| **2회** | 자동 롤백 + 상세 분석 리포트 | 반복 실패이므로 분석 리포트 생성 |
| **3회** | 파이프라인 잠금 + 이메일 알림 | 인간 개입이 필요한 상태 |

---

## 1회 실패

```
실패 감지
  → 자동 롤백 실행
  → rollback-registry에서 이전 이미지 복원
  → 헬스체크로 롤백 성공 확인
  → pipeline.json에 실패 기록
  → consecutive_failures: 1
```

## 2회 연속 실패

```
실패 감지
  → 자동 롤백 실행
  → 상세 분석 리포트 생성:
    - 실패 스테이지 및 원인
    - 관련 로그 요약
    - 최근 2회 실패 비교
  → pipeline.json에 실패 기록
  → consecutive_failures: 2
```

## 3회 연속 실패 (잠금)

```
실패 감지
  → 자동 롤백 실행
  → 파이프라인 잠금 (pipeline_locked: true)
  → /notify-important 이메일 알림 발송
  → 이후 /gonsautopilot 실행 시 잠금 안내
```

### 잠금 상태 확인

```
/gonsautopilot:status
```

출력:
```
  상태: LOCKED
  잠금 이유: 연속 3회 파이프라인 실패
  마지막 실패: 2026-02-06T16:05:30+09:00

  → 문제 해결 후 잠금을 해제하세요.
```

### 잠금 해제

잠금은 수동으로만 해제할 수 있습니다. `state/pipeline.json`에서 `pipeline_locked`를 `false`로 변경하거나, 상태 관리 스크립트를 사용합니다:

```bash
lib/state-manager.sh unlock-pipeline
```

---

## 성공 시 카운터 리셋

파이프라인이 성공하면 `consecutive_failures`가 0으로 리셋됩니다.

```
파이프라인 성공
  → consecutive_failures: 0
  → 정상 운영 상태
```

---

## 이메일 알림

3회 연속 실패 시 `/notify-important` 스킬을 통해 이메일이 발송됩니다.

### 알림 내용

- 파이프라인 ID
- 실패 스테이지 및 원인
- 연속 실패 횟수
- 잠금 시각
- 최근 3회 실패 요약

---

## 다음 단계

- [[3-Layer Safety|Safety]] — 안전 장치 시스템
- [[슬래시 명령어|Commands]] — 상태 조회 및 롤백 명령어
